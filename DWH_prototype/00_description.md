# Краткое описание задачи

- построить систему источник, содержащий статусы задач и расчет cdc, с генератором синтетических данных 
- построить прототип хранилища данных со слоями
  -  stage - для загрузки из источника,
  -  ods - для расчета и хранения историчных данных
  -  report - для создания и хранения представлений с актуальными данными и витрин с тблицами фактов
- разработать скрипт c DAG Airflow для последовательного запуска процессов генератора источника и расчета таблиц приемника
- создать документацию с описанием системы

# Решение

## Система - источник

В качестве тестовых данных используются статусы заказов, подлежащих сборке и доставке, а также информация о соответствии заказа и ответственного за него сотрудника + словари со статусами заказов и сотрудниками

В систему источник со склада предприятия попадают:
  - информация о актуальном статусе заказа (например при сканировании штрихкода коробки или накладной разными отделами или службами (отдел сборки, доставки и пр.))
  - информация о актуальном ответственном за заказ (например получается из идентификатора личного сканера или устройства сотрудника)


### Слои и сущности / функции в системе - источнике

| **#** | **Слой источника**  | **Элемент слоя**               | **Описание элемента**                                                                                                                                                         |
|-------|---------------------|--------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 1     | oltp_src_system     | order_data                     | **Таблица** со статусами заказов, поступающие из предприятия                                                                                                                  |
| 2     |                     | order_employers_data           | **Таблица** с ответственными за заказ сотрудниками                                                                                                                            |
| 3     |                     | order_status_dict              | **Таблица** со словарем статусов заказов                                                                                                                                      |
| 4     |                     | employers_dict                 | **Таблица** со словарем сотрудников ответственных за заказ                                                                                                                    |
| 5     |                     | _table_tech                    | **Таблица** со служебными переменными для генератора синтетических данных                                                                                                     |
| 6     |                     | create_orders()                | **Функция** генерации новых заказов и ответственных(добавления записей в `order_data` и `order_employers_data`)                                                               |
| 7     |                     | update_orders()                | **Функция** обновления N случайных существующихзаписей в `order_data` и `order_employers_data`                                                                                |
| 8     |                     | delete_existed_orders()        | **Функция** удаления N случайных записей о заказах в `order_data` и соответствующих записей о ответственных в `order_employers_data`                                          |
| 9     |                     | order_data_changes()           | **Триггерная процедура** для обработки изменений в таблице `order_data`                                                                                                       |
| 10    |                     | order_employers_data_changes() | **Триггерная процедура** для обработки изменений в таблице `order_employers_data`                                                                                             |
| 11    |                     | export_src_dict_csv()          | **Функция** для экспорта словарей `order_status_dict` и `employers_dict` в csv файлы                                                                                          |
| 12    | oltp_cdc_src_system | order_data_cdc                 | **Таблица** с логом CDC для сущности `oltp_src_system.order_data`. Заполняется автоматически триггерной процедурой `oltp_src_system.order_data_changes()`                     |
| 13    |                     | order_employers_data_cdc       | **Таблица** с логом CDC для сущности `oltp_src_system.order_employers_data`. Заполняется автоматически триггерной процедурой `oltp_src_system.order_employers_data_changes()` |
| 14    |                     | export_cdc_src_data_csv()      | **Функция** для экспорта логов CDC `order_data_cdc` и `order_employers_data_cdc` в csv файлы |

### Иллюстрация возможных статусов заказов и схема смены статусов заказа в тестовых данных

<image src="./00_status_graph.png" width="1280" alt="Граф зависимостей статусов заказа">
 
Генератор при при вызове функции update_orders() руководствуется информацией из поля `next_status_list` в словаре `order_status_dict`. 

В качестве следующего статуса выбирается соответствующее случайное значение из этого поля.

### Модель данных источника

| **#** | **Схема**           | **Сущность**             | **Наименование поля** | **Описание поля**                                                                                                               | **PK/FK** | **Тип данных** | **FK-сущность**   | **FK-поле** |
|-------|---------------------|--------------------------|-----------------------|---------------------------------------------------------------------------------------------------------------------------------|-----------|----------------|-------------------|-------------|
| 1     | oltp_src_system     | order_data               | order_id              | Идентификатор заказа                                                                                                            | PK        | integer        |                   |             |
| 2     |                     |                          | status_id             | Идентификатор статуса                                                                                                           | FK        | integer        | order_status_dict | status_id   |
| 3     |                     |                          | create_dttm           | Дата и время создания записи                                                                                                    |           | timestamptz(0) |                   |             |
| 5     | oltp_src_system     | order_employers_data     | order_id              | Идентификатор заказа                                                                                                            | PK        | integer        |                   |             |
| 6     |                     |                          | employee_id           | Идентификатор сотрудника                                                                                                        | FK        | integer        | employers_dict    | employee_id |
| 7     |                     |                          | create_dttm           | Дата и время создания записи                                                                                                    |           | timestamptz(0) |                   |             |
| 8     | oltp_src_system     | order_status_dict        | status_id             | Идентификатор статуса                                                                                                           | PK        | integer        |                   |             |
| 9     |                     |                          | status_name           | Название статуса                                                                                                                |           | text           |                   |             |
| 10    |                     |                          | next_status_list      | Список ИД возможных следующих статусов                                                                                          |           | integer[]      |                   |             |
| 11    | oltp_src_system     | employers_dict           | employee_id           | Идентификатор сотрудника                                                                                                        | PK        | integer        |                   |             |
| 12    |                     |                          | employee_name         | Имя сотрудника                                                                                                                  |           | text           |                   |             |
| 13    |                     |                          | sex_flg               | Пол сотрудника (False - female, True - male)                                                                                    |           | boolean        |                   |             |
| 14    |                     |                          | age_num               | Возраст сотрудника (кол-во полных лет)                                                                                          |           | integer        |                   |             |
| 15    | oltp_src_system     | _table_tech              | rnd_int               | ячейка для обмена интервалом дат между функциями                                                                                |           | integer        |                   |             |
| 16    |                     |                          | days_ago_start        | Cтарт интервала для выбора даты создания задачи,<br>как количество дней назад от текущей даты до требуемой даты                 |           | integer        |                   |             |
| 17    |                     |                          | days_ago_end          | Конец интервала для выбора даты создания задачи,<br>как количество дней назад от текущей даты до требуемой даты                 |           | integer        |                   |             |
| 18    |                     |                          | hours_ahead_start     | Cтарт интервала для выбора момента следующего обновления задач,<br>как количество часов вперед от последнего момента обновления |           | integer        |                   |             |
| 19    |                     |                          | hours_ahead_end       | Конец интервала для выбора момента следующего обновления задач,<br>как количество часов вперед от последнего момента обновления |           | integer        |                   |             |
| 20    | oltp_cdc_src_system | order_data_cdc           | order_id              | Идентификатор заказа                                                                                                            |           | integer        |                   |             |
| 21    |                     |                          | status_id             | Идентификатор статуса                                                                                                           |           | integer        |                   |             |
| 22    |                     |                          | create_dttm           | Дата и время создания записи                                                                                                    |           | timestamptz(0) |                   |             |
| 23    |                     |                          | operation_type        | Тип операции изменения I/U/D - вставка/обновление/удаление                                                                      |           | bpchar(1)      |                   |             |
| 24    |                     |                          | updated_dttm          | Дата и время изменения записи                                                                                                   |           | timestamptz(0) |                   |             |
| 25    | oltp_cdc_src_system | order_employers_data_cdc | order_id              | Идентификатор заказа                                                                                                            |           | integer        |                   |             |
| 26    |                     |                          | employee_id           | Идентификатор сотрудника                                                                                                        |           | integer        |                   |             |
| 27    |                     |                          | create_dttm           | Дата и время создания записи                                                                                                    |           | timestamptz(0) |                   |             |
| 28    |                     |                          | operation_type        | Тип операции изменения I/U/D - вставка/обновление/удаление                                                                      |           | bpchar(1)      |                   |             |
| 29    |                     |                          | updated_dttm          | Дата и время изменения записи                                                                                                   |           | timestamptz(0) |                   |             |

### Функции для генерации и изменения записей

#### **oltp_src_system.create_orders()**

> Функция для генерации строк с записями о статусах заказа в таблицах `order_data` и `order_employers_data`
>
> Функция принимает 
>  - "row_num" integer` - количество генерируемых записей (строк), по умолчанию 5
>
> Функция записывает указанное количество строк в таблицу `order_data` с начальным статусом "unfulfilled" с временем создания - дата и время запуска функции и генерирует ответственных для добавленных в `order_data` заказов (добавляет 
записи в `order_employers_data`)
> Функция использует generate_series для формирования списка значений id и случайный id сотрудника из словаря сотрудников.
> 
> Функция возвращает один массив integer[]:
>  - `integer[1]` - фактически добавленное количество записей в `order_data` 
>  - `integer[2]` - фактически добавленное количество записей в `order_employers_data` 
>  - В случае, если `row_num` меньше или равно 0,  возвращает [0, 0]

#### **oltp_src_system.update_orders()**

> Функция для обновления случайных строк в существующих таблицах `order_data` и `order_employers_data`
> 
> Функция принимает 
>  - `row_num integer` - количество записей (строк), подлежащих обновлению, по умолчанию 5
>  
> Функция обновляет случайную выборку в `order_data` и `order_employers_data` содержащую количество строк = row_num. Выборки формируются независимо друг от друга, то есть в при смене статуса в `order_data` для этого номера заказа не обязательно произойдет смена ответственного. 
> 
> При этом функция также генерирует случайную временную дельту для определения даты/времени смены статуса заказа и его ответственного, и эта дельта общая для смены стасуса заказа и смены ответственного. То есть смена статуса и смена ответственного происходят в одинаковые моменты времени, но для разных заказов. Это особенность конкретно этих тестовых синтетических данных.
> 
> Для обновления статусов записей в выборке используется словарь `oltp_src_system.order_status_dict`, где для каждого статуса заказа даны ИД всех возможных последующих статусов, в виде массива integer[]
Если статус может быть конечным для заказа, в массиве указывается также номер самого этого статуса
> 
> Функция возвращает один массив integer[]:
>  - `integer[1]` - фактически измененное количество записей в `order_data` 
>  - `integer[2]` - фактически измененное количество записей в `order_employers_data` 

#### **oltp_src_system.delete_existed_orders()**

> Функция для удаления случайных строк в существующих таблицах `order_data` и `order_employers_data`
> 
> Функция принимает 
>  - `row_num integer` - количество записей (строк), подлежащих удалению, по умолчанию 5
>  
> Функция удаляет выборку в `order_data` и `order_employers_data` содержащую случайные order_id в количестве = row_num. Выборка одна для двух таблиц, то есть в при удалении заказа в `order_data` запись с соответствующим `order_id` удаляется и в `order_employers_data`. 
> 
> Функция возвращает один массив integer[]:
>  - `integer[1]` - фактически удаленное количество записей в `order_data` 
>  - `integer[2]` - фактически удаленное количество записей в `order_employers_data` 


#### **oltp_src_system.order_data_changes()**

> Процедура для обработки триггера таблицы `oltp_src_system.order_data`
> 
> Процедура вызывается при срабатывании триггера на DELETE / UPDATE / INSERT записей в `oltp_src_system.order_data`
> Процедура записывает в существующую CDC таблицу `oltp_cdc_src_system.order_data_cdc` новую или измененную запись в `oltp_src_system.order_data`, или в случае DELETE - удаляемую запись, и добавляет технические поля: 
>  - `operation_type` - тип операции изменения, D/U/I, соответственно DELETE / UPDATE / INSERT
> - `updated_dttm` - дата и время операции изменения
> Дату и время операции изменения / удаления ("U"/"D") функция получает из даты/времени создания существующей записи в `oltp_src_system.order_data` + временная дельта, которую сформировала функция `oltp_src_system.update_orders()` и записала в техническую таблицу `oltp_src_system._table_tech`.
> Дату и время вставки ("I") функция определяет как дату и время создания существующей записи, взятой из `oltp_src_system.order_data`
> 
> Процедура не принимает и не возвращает аргументов. 

#### **oltp_src_system.order_employers_data_changes()**

> Процедура для обработки триггера таблицы `oltp_src_system.order_employers_data`
> 
> Процедура полностью аналогична процедуре `oltp_src_system.order_data_changes()` но работает с таблицей `oltp_cdc_src_system.order_employers_data_cdc` на основе данных из `oltp_src_system.order_employers_data`
> 
> Процедура не принимает и не возвращает аргументов. 


Скрипт создания триггеров для таблиц `oltp_src_system.order_data` и `oltp_src_system.order_employers_data`
```SQL
CREATE TRIGGER order_data_trigger_audit
AFTER INSERT OR UPDATE OR DELETE ON oltp_src_system.order_data
 FOR EACH ROW EXECUTE PROCEDURE oltp_src_system.order_data_changes();
-------------------------------------------------------------------------------
CREATE TRIGGER order_employers_data_trigger_audit
AFTER INSERT OR UPDATE OR DELETE ON oltp_src_system.order_employers_data
 FOR EACH ROW EXECUTE PROCEDURE oltp_src_system.order_employers_data_changes();
```

### Функции для экспорта данных для обмена с приемником

В реализованном скрипте DAG для Airflow приемник данных получает данные непосредственно из таблиц схемы `oltp_cdc_src_system` источника.

 Однако в скрипте реализованы также функции для обмена данными через файловую систему, при помощи csv файлов.

#### **oltp_cdc_src_system.export_cdc_src_data_csv()**

> Функция сохраняет таблицы `order_data_cdc` и `order_employers_data_cdc` в csv файлы на диске
> 
> Функция принимает 
>  - `table_path_1 text` - путь к csv файлу для order_data_cdc, по умолчанию '/tmp/order_data_cdc.csv'
>  - `table_path_2 text` - путь к csv файлу для order_employers_data_cdc, по умолчанию '/tmp/order_employers_data_cdc.csv'
> 
> Функция возвращает один массив integer[]:
>  - `integer[1]` - фактически сохраненное количество записей из `order_data` 
>  - `integer[2]` - фактически сохраненное количество записей из `order_employers_data` 

#### **oltp_src_system.order_status_dict()**

> Функция сохраняет таблицы `order_status_dict` и `employers_dict` в csv файлы на диске
> 
> Функция принимает 
>  - `table_path_1 text` - путь к csv файлу для order_status_dict, по умолчанию '/tmp/order_status_dict.csv'
>  - `table_path_2 text` - путь к csv файлу для employers_dict, по умолчанию '/tmp/employers_dict.csv'
> 
> Функция возвращает один массив integer[]:
>  - `integer[1]` - фактически сохраненное количество записей из `order_status_dict` 
>  - `integer[2]` - фактически сохраненное количество записей из `employers_dict` 

### S2T таблица для сущностей схемы `oltp_cdc_src_system` 

| **#** | **Область источника** | **Таблица-источник** | **Поле таблицы-источника**                                                                                  | **Область приемника** | **Таблица-приемник**     | **Поле таблицы-приемника** | **Тип данных** | **Описание поля**             | **Примечание**                                      |
|-------|-----------------------|----------------------|-------------------------------------------------------------------------------------------------------------|-----------------------|--------------------------|----------------------------|----------------|-------------------------------|-----------------------------------------------------|
| 1     | oltp_src_system       | order_data           | order_id                                                                                                    | oltp_cdc_src_system   | order_data_cdc           | order_id                   | integer        | Идентификатор заказа          |                                                     |
| 2     | oltp_src_system       | order_data           | status_id                                                                                                   | oltp_cdc_src_system   | order_data_cdc           | status_id                  | integer        | Идентификтор статуса          |                                                     |
| 3     | oltp_src_system       | order_data           | create_dttm                                                                                                 | oltp_cdc_src_system   | order_data_cdc           | create_dttm                | timestamptz(0) | Дата/время создания записи    |                                                     |
| 4     |                       |                      | Расчетное поле в зависимости<br>от значения передаваемого триггером<br>`order_data_trigger_audit`           | oltp_cdc_src_system   | order_data_cdc           | operation_type             | bpchar(1)      | Метка операции изменения      | 'I' - вставка<br>'U' - обновление<br>'D' - удаление |
| 5     | oltp_src_system       | order_data           | create_dttm                                                                                                 | oltp_cdc_src_system   | order_data_cdc           | updated_dttm               | timestamptz(0) | Дата и время изменения записи |                                                     |
| 6     | oltp_src_system       | _table_tech          | rnd_int                                                                                                     | oltp_cdc_src_system   | order_data_cdc           | updated_dttm               | timestamptz(0) | Дата и время изменения записи |                                                     |
| 7     | oltp_src_system       | order_employers_data | order_id                                                                                                    | oltp_cdc_src_system   | order_employers_data_cdc | order_id                   | integer        | Идентификатор заказа          |                                                     |
| 8     | oltp_src_system       | order_employers_data | employee_id                                                                                                 | oltp_cdc_src_system   | order_employers_data_cdc | employee_id                | integer        | Идентификатор сотрудника      |                                                     |
| 9     | oltp_src_system       | order_employers_data | create_dttm                                                                                                 | oltp_cdc_src_system   | order_employers_data_cdc | create_dttm                | timestamptz(0) | Дата/время создания записи    |                                                     |
| 10    |                       |                      | Расчетное поле в зависимости<br>от значения передаваемого триггером<br>`order_employers_data_trigger_audit` | oltp_cdc_src_system   | order_employers_data_cdc | operation_type             | bpchar(1)      | Метка операции изменения      | 'I' - вставка<br>'U' - обновление<br>'D' - удаление |
| 11    | oltp_src_system       | order_employers_data | create_dttm                                                                                                 | oltp_cdc_src_system   | order_employers_data_cdc | updated_dttm               | timestamptz(0) | Дата и время изменения записи |                                                     |
| 12    | oltp_src_system       | _table_tech          | rnd_int                                                                                                     | oltp_cdc_src_system   | order_employers_data_cdc | updated_dttm               | timestamptz(0) | Дата и время изменения записи |                                                     |

## Система - приемник

Прототип приемника построен со следующими вводными данными от источника: 
 - Источник работает непрерывно, и сохраняет версии своих данных через механизм cdc в своем отдельном слое
 - лог cdc источник хранит в течение некоторого времени, например неделю

Схема получения данных приемником 
 - Приемник получает данные из источника с известной периодичностью, не совпадающей с фактом обновления данных в источнике, например раз в сутки, в определенное время, когда источник менее всего нагружен.
 - Так как периодичность обновления данных в источнике и периодичность получения данных приемником не синхронизированы, то приемник для расчета историчности использует не временной штамп загрузки данных а временные штампы из cdc источника
 - Приемник каждые сутки получает полный слепок CDC источника, и переносит его в свой **stage** не рассчитывая в этот момент инкремент, для минимизации времени обращения к источнику.
 - В момент получения данных из источника в слой **stage** приемник обогащает данные техническими полями:
   - `hash` - хэш содержимого строки из таблицы источника, вычисленный по алгоритму sha256
   - `src_name` - наименование системы источника
   - `load_dttm` - дата / время получения данных системой-приемником
 - **stage** слой приемника очищается при каждом обновлении данных.
 - Далее данные находящиеся в слое **stage** приемника попадают в слой **ODS** который хранит все версии данных из **stage** с непрерывной историчностью. Данные в **ODS** попадают инкрементально. Каждый слой прототипа смотрит только на предыдущие слои и на себя (для сравнения), данные из следующих слоев никаким образом не используются.
 - Данные из **stage** в **ODS** переносят функции слоя **ODS**, которые преобразовывают временные штампы данных в непрерывную историчность, включают дополнительные поля:
   - `valid_from_dttm` - дата/время начала действия версии
   - `valid_from_dttm` - дата/время окончания действия версии
   - `deleted_flg` - флаг удаленной версии в источнике
   - `deleted_dttm` - дата и время удаления версии из источника     
   - и другие поля при необходимости 
- Из полученных из **stage** данных исключаются технические поля CDC источника: create_dttm, update_dttm, operation_type


### Слои и сущности / функции в системе - приемнике

| **#** | **Слой приемника** | **Элемент слоя**                    | **Описание элемента**                                                                                                                                 |
|-------|--------------------|-------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------|
| 1     | dwh_stage          | order_data_cdc                      | **Таблица** с логом CDC статусов заказов, полученная из источника.                                                                                    |
| 2     |                    | order_employers_data_cdc            | **Таблица** с логом CDC ответственных за заказ, полученная из источника.                                                                              |
| 3     |                    | order_status_dict                   | **Таблица** со словарем статусов заказов, полученным из источника                                                                                     |
| 4     |                    | employers_dict                      | **Таблица** со словарем сотрудников, полученным из источника                                                                                          |
| 5     |                    | load_order_data_cdc()               | **Функция** загрузки таблицы `order_data_cdc` источника в stage, непосредственно из БД                                                                |
| 6     |                    | load_order_data_cdc_csv()           |   ..то же, но с загрузкой из csv файла                                                                                                                |
| 7     |                    | load_order_employers_data_cdc()     | **Функция** загрузки таблицы `order_emloyers_data_cdc` источника в stage, непосредственно из БД                                                       |
| 8     |                    | load_order_employers_data_cdc_csv() |   ..то же, но с загрузкой из csv файла                                                                                                                |
| 9     |                    | load_src_dict()                     | **Функция** загрузки словарей `order_status_dict` и `employers_dict` источника в stage, непосредственно из БД                                         |
| 10    |                    | load_src_dict_csv()                 |   ..то же, но с загрузкой из csv файла                                                                                                                |
| 11    | dwh_ods            | order_data_hist                     | **Таблица** хранения всех версий таблицы `dwh_stage.order_data_cdc` c непрерывной историчностью. Данные в слой загружаются инкрементально.            |
| 12    |                    | order_employers_data_hist           | **Таблица** хранения всех версий таблицы `dwh_stage.order_emloyers_data_cdc` c непрерывной историчностью. Данные в слой загружаются инкрементально.   |
| 13    |                    | order_status_dict_hist              | **Таблица** хранения всех версий таблицы `dwh_stage.order_status_dict` c непрерывной историчностью. Данные в слой загружаются инкрементально.         |
| 14    |                    | employers_dict_hist                 | **Таблица** хранения всех версий таблицы `dwh_stage.employers_dict` c непрерывной историчностью. Данные в слой загружаются инкрементально.            |
| 15    |                    | date_calendar                       | **Таблица** хранения календаря с диапазоном дат охватывающим все даты в данных из ODS слоя для построения аналитических отчетов.                      |
| 16    |                    | load_order_data_hist()              | **Функция** загрузки данных из `dwh_stage.order_data_cdc` в ODS, выполняющая расчет инкремента, обновление полей версионности                         |
| 17    |                    | load_order_employers_data_hist()    | **Функция** загрузки данных из `dwh_stage.order_employers_data_cdc` в ODS, выполняющая расчет инкремента, обновление полей версионности               |
| 18    |                    | load_status_dict_hist()             | **Функция** загрузки данных из `dwh_stage.order_status_dict` в ODS, выполняющая расчет инкремента, обновление полей версионности                      |
| 19    |                    | load_employers_dict_hist()          | **Функция** загрузки данных из `dwh_stage.employers_dict` в ODS, выполняющая расчет инкремента, обновление полей версионности                         |
| 20    |                    | update_calendar()                   | **Функция** добавляющая записи в календарь `dwh_ods.date_calendar` для данных, находящихся в ODS                                                      |
| 21    | report             | _dm_order_state_tech                | **Мат. представление** - техническое представление основа - неагрегированные данные о заказах, за все время                                           |
| 22    |                    | dm_actual_order_state               | **Мат. представление** - собирает агрегированные данные о актуальных заказах (или для определенной даты), построено на основе  `_dm_order_state_tech` |
| 23    |                    | dm_actual_order_state_2             | **Мат. представление** - собирает агрегированные данные о актуальных заказах (или для определенной даты) - без использования основы                   |
| 24    |                    | dm_emloyers_stat                    | **Мат. представление** - статистика по сотрудникам за все время                                                                                       |
| 25    |                    | dm_orders_stat                      | **Мат. представление** - статистика по заказам за все время                                                                                           |
| 26    |                    | _dm_date_stat_tech                  | **Мат. представление** - техническое представление основа - содержит неагрегированную информацию по всем дням из календаря                            |
| 27    |                    | dm_date_dem_stat                    | **Мат. представление** - содержит агрегированную демографическую информацию по всем дням из календаря                                                 |
| 28    |                    | dm_date_order_stat                  | **Мат. представление** - содержит агрегированную информацию о заказах по всем дням из календаря                                                       |
| 29    | _test              | airflow_check_log                   | **Таблица** с логом проверок данных, выполняемых Airflow                                                                                              |
| 30    |                    | airflow_task_log                    | **Таблица** с логом добавления / изменения строк функциями генератора и прототипа DWH, выполняемыми Airflow                                           |
| 31    |                    | export_import_csv                   | **Функция** служебная процедура запускающая обмен данными между источником и приемником через файловую систему                                        |
| 32    |                    | export_import_db                    | **Функция** служебная процедура запускающая обмен данными между источником и приемником непосредственно через БД                                      |
| 33    |                    | testing_procedure                   | **Функция** процедура запускающая генератор источника, обмен данными между источником и приемником и работу прототипа хранилища                       |

### Структура прототипа приемника

<image src="./02_03_prototype_graph.png" width="1280" alt="Схема прототипа приемника">
 
### Модель данных приемника

| **#** | **Схема** | **Сущность**             | **Наименование поля** | **Описание поля**                            | **PK/FK** | **Тип данных** | **FK-сущность**        | **FK-поле** |
|-------|-----------|--------------------------|-----------------------|----------------------------------------------|-----------|----------------|------------------------|-------------|
| 2     | dwh_stage | order_data_cdc           | order_id              | Идентификатор заказа                         | PK        | integer        |                        |             |
| 3     |           |                          | status_id             | Идентификатор статуса                        | FK        | integer        | order_status_dict      | status_id   |
| 5     |           |                          | create_dttm           | Дата и время создания записи                 |           | timestamptz(0) |                        |             |
| 6     |           |                          | operation_type        | Тип операции изменения                       |           | bpchar(1)      |                        |             |
| 7     |           |                          | update_dttm           | Дата и время изменения записи                | PK        | timestamptz(0) |                        |             |
| 8     |           |                          | hash                  | хэш строки источника                         |           | text           |                        |             |
| 9     |           |                          | src_name              | Имя системы источника                        | PK        | varchar(255)   |                        |             |
| 10    |           |                          | load_dttm             | Дата и время загрузки в приемник             | PK        | timestamptz(0) |                        |             |
| 11    | dwh_stage | order_employers_data_cdc | order_id              | Идентификатор заказа                         | PK        | integer        |                        |             |
| 12    |           |                          | employee_id           | Идентификатор сотрудника                     | FK        | integer        | employers_dict         | employee_id |
| 13    |           |                          | create_dttm           | Дата и время создания записи                 |           | timestamptz(0) |                        |             |
| 14    |           |                          | operation_type        | Тип операции изменения                       |           | bpchar(1)      |                        |             |
| 15    |           |                          | update_dttm           | Дата и время изменения записи                | PK        | timestamptz(0) |                        |             |
| 16    |           |                          | hash                  | хэш строки источника                         |           | text           |                        |             |
| 17    |           |                          | src_name              | Имя системы источника                        | PK        | varchar(255)   |                        |             |
| 18    |           |                          | load_dttm             | Дата и время загрузки в приемник             | PK        | timestamptz(0) |                        |             |
| 19    | dwh_stage | order_status_dict        | status_id             | Идентификатор статуса                        | PK        | integer        |                        |             |
| 20    |           |                          | status_name           | Название статуса                             |           | text           |                        |             |
| 21    |           |                          | next_status_list      | Список ИД возможных следующих статусов       |           | integer[]      |                        |             |
| 22    |           |                          | hash                  | хэш строки источника                         |           | text           |                        |             |
| 23    |           |                          | src_name              | Имя системы источника                        | PK        | varchar(255)   |                        |             |
| 24    |           |                          | load_dttm             | Дата и время загрузки в приемник             | PK        | timestamptz(0) |                        |             |
| 25    | dwh_stage | employers_dict           | employee_id           | Идентификатор сотрудника                     | PK        | integer        |                        |             |
| 26    |           |                          | employee_name         | Имя сотрудника                               |           | text           |                        |             |
| 27    |           |                          | sex_flg               | Пол сотрудника (False - female, True - male) |           | boolean        |                        |             |
| 28    |           |                          | age_num               | Возраст сотрудника (кол-во полных лет)       |           | integer        |                        |             |
| 29    |           |                          | hash                  | хэш строки источника                         |           | text           |                        |             |
| 30    |           |                          | src_name              | Имя системы источника                        | PK        | varchar(255)   |                        |             |
| 31    |           |                          | load_dttm             | Дата и время загрузки в приемник             | PK        | timestamptz(0) |                        |             |
| 32    | dwh_ods   | order_data_hist          | order_id              | Идентификатор заказа                         | PK        | integer        |                        |             |
| 33    |           |                          | status_id             | Идентификатор статуса                        | FK        | integer        | order_status_dict_hist | status_id   |
| 34    |           |                          | valid_from_dttm       | Дата/время начала действия версии            | PK        | timestamptz(0) |                        |             |
| 35    |           |                          | valid_to_dttm         | Дата/время конца действия версии             |           | timestamptz(0) |                        |             |
| 36    |           |                          | deleted_flg           | Флаг удаленной в источнике записи            |           | boolean        |                        |             |
| 37    |           |                          | deleted_dttm          | Дата/время удаления записи                   |           | timestamptz(0) |                        |             |
| 38    |           |                          | src_name              | Имя системы источника                        |           | varchar(255)   |                        |             |
| 39    |           |                          | hash                  | хэш строки источника                         |           | text           |                        |             |
| 40    | dwh_ods   | dwh_ods                  | order_id              | Идентификатор заказа                         | PK        | integer        |                        |             |
| 41    |           |                          | employee_id           | Идентификатор сотрудника                     | FK        | integer        | employers_dict_hist    | employee_id |
| 42    |           |                          | valid_from_dttm       | Дата/время начала действия версии            | PK        | timestamptz(0) |                        |             |
| 43    |           |                          | valid_to_dttm         | Дата/время конца действия версии             |           | timestamptz(0) |                        |             |
| 44    |           |                          | deleted_flg           | Флаг удаленной в источнике записи            |           | boolean        |                        |             |
| 45    |           |                          | deleted_dttm          | Дата/время удаления записи                   |           | timestamptz(0) |                        |             |
| 46    |           |                          | src_name              | Имя системы источника                        |           | varchar(255)   |                        |             |
| 47    |           |                          | hash                  | хэш строки источника                         |           | text           |                        |             |
| 48    | dwh_ods   | order_status_dict_hist   | status_id             | Идентификатор статуса                        | PK        | integer        |                        |             |
| 49    |           |                          | status_name           | Название статуса                             |           | text           |                        |             |
| 50    |           |                          | next_status_list      | Список ИД возможных следующих статусов       |           | integer[]      |                        |             |
| 51    |           |                          | valid_from_dttm       | Дата/время начала действия версии            | PK        | timestamptz(0) |                        |             |
| 52    |           |                          | valid_to_dttm         | Дата/время конца действия версии             |           | timestamptz(0) |                        |             |
| 53    |           |                          | deleted_flg           | Флаг удаленной в источнике записи            |           | boolean        |                        |             |
| 54    |           |                          | deleted_dttm          | Дата/время удаления записи                   |           | timestamptz(0) |                        |             |
| 55    |           |                          | src_name              | Имя системы источника                        |           | varchar(255)   |                        |             |
| 56    |           |                          | hash                  | хэш строки источника                         |           | text           |                        |             |
| 57    | dwh_ods   | employers_dict_hist      | employee_id           | Идентификатор сотрудника                     | PK        | integer        |                        |             |
| 58    |           |                          | employee_name         | Имя сотрудника                               |           | text           |                        |             |
| 59    |           |                          | sex_flg               | Пол сотрудника (False - female, True - male) |           | boolean        |                        |             |
| 60    |           |                          | age_num               | Возраст сотрудника (кол-во полных лет)       |           | integer        |                        |             |
| 61    |           |                          | valid_from_dttm       | Дата/время начала действия версии            | PK        | timestamptz(0) |                        |             |
| 62    |           |                          | valid_to_dttm         | Дата/время конца действия версии             |           | timestamptz(0) |                        |             |
| 63    |           |                          | deleted_flg           | Флаг удаленной в источнике записи            |           | boolean        |                        |             |
| 64    |           |                          | deleted_dttm          | Дата/время удаления записи                   |           | timestamptz(0) |                        |             |
| 65    |           |                          | src_name              | Имя системы источника                        |           | varchar(255)   |                        |             |
| 66    |           |                          | hash                  | хэш строки источника                         |           | text           |                        |             |
| 67    | dwh_ods   | date_calendar            | date_id               | Идентификатор даты                           | PK        | integer        |                        |             |
| 68    |           |                          | date_actual           | Дата в формате date                          |           | date           |                        |             |
| 69    |           |                          | year                  | Год в формате NNNN                           |           | integer        |                        |             |
| 70    |           |                          | quarter               | Номер квартала в году                        |           | integer        |                        |             |
| 71    |           |                          | month                 | Номер месяца в году                          |           | integer        |                        |             |
| 72    |           |                          | week                  | Номер недели в году                          |           | integer        |                        |             |
| 73    |           |                          | day_of_month          | День месяца                                  |           | integer        |                        |             |
| 74    |           |                          | day_of_week           | День недели, где 1 - ПН, 7 - ВСКР            |           | integer        |                        |             |
| 75    |           |                          | is_weekday            | Флаг буднего дня                             |           | boolean        |                        |             |
| 76    |           |                          | is_holiday            | Флаг выходного дня                           |           | boolean        |                        |             |
| 77    |           |                          | fiscal_year           | Финансовый год                               |           | integer        |                        |             |

### Функции для загрузки записей, слой **STAGE**

#### **dwh_stage.load_order_data_cdc()**

> Функция для загрузки таблицы `order_data_cdc` в слой **stage** из источника
>
> Функция принимает 
>  - `src_name_` `TEXT` - имя системы источника, по умолчанию 'oltp_cdc_src_system'
>
> Функция очищает существующую таблицу `dwh_stage.order_data_cdc` и загружает в нее данные из таблицы `oltp_cdc_src_system.order_data_cdc` источника, непосредственно из базы данных
> Функция добавляет к записям технические поля
>   - `hash` - хэш строк источника, вычисленный по алгоритму sha256
>   - `src_name` - имя системы источника
>   - `load_dttm` - дата и время загрузки в источник
> 
> Функция возвращает:
>  - `integer` - количество фактически загруженных строк в `dwh_stage.order_data_cdc` 

#### **dwh_stage.load_order_employers_data_cdc()**

> Функция для загрузки таблицы `order_employers_data_cdc` в слой **stage** из источника
>
> Функция принимает 
>  - `src_name_` `TEXT` - имя системы источника, по умолчанию 'oltp_cdc_src_system'
>
> Функция очищает существующую таблицу `dwh_stage.order_employers_data_cdc` и загружает в нее данные из таблицы `oltp_cdc_src_system.order_employers_data_cdc` источника, непосредственно из базы данных
> Функция добавляет к записям технические поля
>   - `hash` - хэш строк источника, вычисленный по алгоритму sha256
>   - `src_name` - имя системы источника
>   - `load_dttm` - дата и время загрузки в источник
> 
> Функция возвращает:
>  - `integer` - количество фактически загруженных строк в `dwh_stage.order_employers_data_cdc` 

#### **dwh_stage.load_src_dict()**

> Функция для загрузки таблицы `order_status_dict` и `employers_dict` в слой **stage** из источника
>
> Функция принимает 
>  - `src_name_` `TEXT` - имя системы источника, по умолчанию 'oltp_src_system'
>
> Функция очищает существующие таблицы `dwh_stage.order_status_dict` и `dwh_stage.employers_dict` и загружает в них данные из таблиц `oltp_src_system.order_status_dict` и `oltp_src_system.employers_dict` источника, непосредственно из базы данных
> Функция добавляет к записям технические поля
>   - `hash` - хэш строк источника, вычисленный по алгоритму sha256
>   - `src_name` - имя системы источника
>   - `load_dttm` - дата и время загрузки в источник
> 
> Функция возвращает один массив integer[]:
>  - `integer[1]` - количество фактически загруженных строк в `dwh_stage.order_status_dict` 
>  - `integer[2]` - количество фактически загруженных строк в `dwh_stage.employers_dict` 

#### **dwh_stage.load_order_data_cdc_csv()**
#### **dwh_stage.load_order_employers_data_cdc_csv()**
#### **dwh_stage.load_src_dict_csv()**

> Функции аналогичны функциям load_order_data_cdc, load_order_employers_data_cdc и load_src_dict
> но загружают таблицы из файловой системы, из csv файлов
>
> Функции принимают 
>  - `table_path_1` `TEXT` - путь к csv файлу с таблицей
>  - `table_path_2` `TEXT` - путь к csv файлу с таблицей employers_dict (для `load_src_dict_csv()`)
>  - `src_name_` `TEXT` - имя системы источника
>
> Функции возвращают одно значение integer для `load_order_data_cdc_csv()` и `load_order_employers_data_cdc_csv()`:
>  - `integer` - количество фактически загруженных строк 
>
>      .. или один массив integer[] (для `load_src_dict_csv()`)
>  - `integer[1]` - количество фактически загруженных строк в `dwh_stage.order_status_dict` 
>  - `integer[2]` - количество фактически загруженных строк в `dwh_stage.employers_dict` 

### Функции для загрузки и модификации записей, слой **ODS**

#### **dwh_ods.load_order_data_hist()**

> Функция для добавления данных в `dwh_ods.order_data_hist`
>
> Функция не принимает аргументов и работает только с таблицей `dwh_stage.order_data_cdc` и существующими данными в `dwh_ods.order_data_hist`
> Функция вычисляет инкремент, добавляет его в таблицу `dwh_ods.order_data_hist`, удаляет и вновь вставляет строки которые были удалены из источника, отмечая их флагом `deleted_flg` и проставляя дату/время удаления `deleted_dttm`
> 
> Функция дополняет данные техническими полями:
>   - `valid_from_dttm` - дата/время начала действия версии
>   - `valid_to_dttm` - дата/время окончания действия версии
>   - `deleted_flg` - флаг уаленной из источника записи
>   - `deleted_dttm` - дата/время удаления записи из источника  
>
> valid_from_dttm получается из update_dttm источника, valid_to_dttm - как следующая запись этого же order_id - 1 секунда
> deleted_flg определяется по записи "D" в operation_type,  deleted_dttm определяется как текущий момент при получении записей.
> 
> Функция возвращает один массив integer[] с 4 значениями:
>  - `integer[1]` - Рассчитанное количество строк в инкременте 
>  - `integer[2]` - Количество заменяемых строк (помеченных на удаление) удаленных из ODS
>  - `integer[3]` - Количество заменяемых строк (помеченных на удаление) вставленных из ODS
>  - `integer[4]` - количество фактически загруженных строк из инкремента 
>  - При нормальном результате integer[1] = integer[4], а integer[2] = integer[3]

#### **dwh_ods.load_order_employers_data_hist()**
#### **dwh_ods.load_status_dict_hist()**
#### **dwh_ods.load_employers_dict_hist()**

> Функции полностью аналогичны `dwh_ods.load_order_data_hist()` 
> но работают с таблицами:
>
> - load_order_employers_data_hist() : `dwh_stage.order_employers_data_cdc` >> `dwh_ods.order_employers_data_hist`
> - load_status_dict_hist() : `dwh_stage.order_status_dict` >> `dwh_ods.order_status_dict_hist`
> - load_employers_dict_hist() : `dwh_stage.employers_dict` >> `dwh_ods.employers_dict_hist`
>
> Функция возвращает один массив integer[] с 4 значениями:
>  - `integer[1]` - Рассчитанное количество строк в инкременте 
>  - `integer[2]` - Количество заменяемых строк (помеченных на удаление) удаленных из ODS
>  - `integer[3]` - Количество заменяемых строк (помеченных на удаление) вставленных из ODS
>  - `integer[4]` - количество фактически загруженных строк из инкремента 
>  - При нормальном результате integer[1] = integer[4], а integer[2] = integer[3]

#### **dwh_ods.update_calendar()**

> Функция обновляет календарь в `dwh_ods.date_calendar`
> 
> Функция не принимает аргументов
> 
> Функция дополняет таблицу `date_calendar` диапазоном дат от минимальной даты  до максимальной даты присутствующих в момент вызова функции в таблицах `dwh_ods.order_data_hist` и `dwh_ods.order_employers_data_hist`.
> 
> При этом существующие в календаре даты не меняются.
> 
> Функция возвращает одно значение integer:
>  - `integer` - Количество добавленных в календарь строк

### S2T таблица для сущностей схемы `dwh_stage` 

| **#** | **Область источника** | **Таблица-источник**     | **Поле таблицы-источника**                                               | **Область приемника** | **Таблица-приемник**     | **Поле таблицы-приемника** | **Тип данных** | **Описание поля**                            | **Примечание** |
|-------|-----------------------|--------------------------|--------------------------------------------------------------------------|-----------------------|--------------------------|----------------------------|----------------|----------------------------------------------|----------------|
| 1     | oltp_cdc_src_system   | order_data_cdc           | order_id                                                                 | dwh_stage             | order_data_cdc           | order_id                   | integer        | Идентификатор заказа                         |                |
| 2     | oltp_cdc_src_system   | order_data_cdc           | status_id                                                                | dwh_stage             | order_data_cdc           | status_id                  | integer        | Идентификатор статуса                        |                |
| 3     | oltp_cdc_src_system   | order_data_cdc           | create_dttm                                                              | dwh_stage             | order_data_cdc           | create_dttm                | timestamptz(0) | Дата и время создания записи                 |                |
| 4     | oltp_cdc_src_system   | order_data_cdc           | operation_type                                                           | dwh_stage             | order_data_cdc           | operation_type             | bpchar(1)      | Тип операции изменения                       |                |
| 5     | oltp_cdc_src_system   | order_data_cdc           | update_dttm                                                              | dwh_stage             | order_data_cdc           | update_dttm                | timestamptz(0) | Дата и время изменения записи                |                |
| 6     |                       |                          | Расчетное поле из функции<br>`dwh_stage.load_order_data_cdc()`           | dwh_stage             | order_data_cdc           | hash                       | text           | хэш строки источника                         |                |
| 7     |                       |                          | Расчетное поле из функции<br>`dwh_stage.load_order_data_cdc()`           | dwh_stage             | order_data_cdc           | src_name                   | varchar(255)   | Имя системы источника                        |                |
| 8     |                       |                          | Расчетное поле из функции<br>`dwh_stage.load_order_data_cdc()`           | dwh_stage             | order_data_cdc           | load_dttm                  | timestamptz(0) | Дата и время загрузки в приемник             |                |
| 9     | oltp_cdc_src_system   | order_employers_data_cdc | order_id                                                                 | dwh_stage             | order_employers_data_cdc | order_id                   | integer        | Идентификатор заказа                         |                |
| 10    | oltp_cdc_src_system   | order_employers_data_cdc | employee_id                                                              | dwh_stage             | order_employers_data_cdc | employee_id                | integer        | Идентификатор сотрудника                     |                |
| 11    | oltp_cdc_src_system   | order_employers_data_cdc | create_dttm                                                              | dwh_stage             | order_employers_data_cdc | create_dttm                | timestamptz(0) | Дата и время создания записи                 |                |
| 12    | oltp_cdc_src_system   | order_employers_data_cdc | operation_type                                                           | dwh_stage             | order_employers_data_cdc | operation_type             | bpchar(1)      | Тип операции изменения                       |                |
| 13    | oltp_cdc_src_system   | order_employers_data_cdc | update_dttm                                                              | dwh_stage             | order_employers_data_cdc | update_dttm                | timestamptz(0) | Дата и время изменения записи                |                |
| 14    |                       |                          | Расчетное поле из функции<br>`dwh_stage.load_order_employers_data_cdc()` | dwh_stage             | order_employers_data_cdc | hash                       | text           | хэш строки источника                         |                |
| 15    |                       |                          | Расчетное поле из функции<br>`dwh_stage.load_order_employers_data_cdc()` | dwh_stage             | order_employers_data_cdc | src_name                   | varchar(255)   | Имя системы источника                        |                |
| 16    |                       |                          | Расчетное поле из функции<br>`dwh_stage.load_order_employers_data_cdc()` | dwh_stage             | order_employers_data_cdc | load_dttm                  | timestamptz(0) | Дата и время загрузки в приемник             |                |
| 17    | oltp_src_system       | order_status_dict        | status_id                                                                | dwh_stage             | order_status_dict        | status_id                  | integer        | Идентификатор статуса                        |                |
| 18    | oltp_src_system       | order_status_dict        | status_name                                                              | dwh_stage             | order_status_dict        | status_name                | text           | Название статуса                             |                |
| 19    | oltp_src_system       | order_status_dict        | next_status_list                                                         | dwh_stage             | order_status_dict        | next_status_list           | integer[]      | Список ИД возможных следующих статусов       |                |
| 20    |                       |                          | Расчетное поле из функции<br>`dwh_stage.load_src_dict()`                 | dwh_stage             | order_status_dict        | hash                       | text           | хэш строки источника                         |                |
| 21    |                       |                          | Расчетное поле из функции<br>`dwh_stage.load_src_dict()`                 | dwh_stage             | order_status_dict        | src_name                   | varchar(255)   | Имя системы источника                        |                |
| 22    |                       |                          | Расчетное поле из функции<br>`dwh_stage.load_src_dict()`                 | dwh_stage             | order_status_dict        | load_dttm                  | timestamptz(0) | Дата и время загрузки в приемник             |                |
| 23    | oltp_src_system       | employers_dict           | employee_id                                                              | dwh_stage             | employers_dict           | employee_id                | integer        | Идентификатор сотрудника                     |                |
| 24    | oltp_src_system       | employers_dict           | employee_name                                                            | dwh_stage             | employers_dict           | employee_name              | text           | Имя сотрудника                               |                |
| 25    | oltp_src_system       | employers_dict           | sex_flg                                                                  | dwh_stage             | employers_dict           | sex_flg                    | boolean        | Пол сотрудника (False - female, True - male) |                |
| 26    | oltp_src_system       | employers_dict           | age_num                                                                  | dwh_stage             | employers_dict           | age_num                    | integer        | Возраст сотрудника (кол-во полных лет)       |                |
| 27    |                       |                          | Расчетное поле из функции<br>`dwh_stage.load_src_dict()`                 | dwh_stage             | employers_dict           | hash                       | text           | хэш строки источника                         |                |
| 28    |                       |                          | Расчетное поле из функции<br>`dwh_stage.load_src_dict()`                 | dwh_stage             | employers_dict           | src_name                   | varchar(255)   | Имя системы источника                        |                |
| 29    |                       |                          | Расчетное поле из функции<br>`dwh_stage.load_src_dict()`                 | dwh_stage             | employers_dict           | load_dttm                  | timestamptz(0) | Дата и время загрузки в приемник             |                |

### S2T таблица для сущностей схемы `dwh_ods` 

| **#** | **Область источника** | **Таблица-источник**     | **Поле таблицы-источника**                                                      | **Область приемника** | **Таблица-приемник**      | **Поле таблицы-приемника** | **Тип данных** | **Описание поля**                            | **Примечание** |
|-------|-----------------------|--------------------------|---------------------------------------------------------------------------------|-----------------------|---------------------------|----------------------------|----------------|----------------------------------------------|----------------|
| 1     | dwh_stage             | order_data_cdc           | order_id                                                                        | dwh_ods               | order_data_hist           | order_id                   | integer        | Идентификатор заказа                         |                |
| 2     | dwh_stage             | order_data_cdc           | status_id                                                                       | dwh_ods               | order_data_hist           | status_id                  | integer        | Идентификатор статуса                        |                |
| 3     | dwh_stage             | order_data_cdc           | update_dttm<br>Расчетное поле, функция<br>`load_order_data_hist()`              | dwh_ods               | order_data_hist           | valid_from_dttm            | timestamptz(0) | Дата/время начала действия версии            |                |
| 4     | dwh_stage             | order_data_cdc           | update_dttm<br>Расчетное поле, функция<br>`load_order_data_hist()`              | dwh_ods               | order_data_hist           | valid_to_dttm              | timestamptz(0) | Дата/время конца действия версии             |                |
| 5     | dwh_stage             | order_data_cdc           | operation_type<br>Расчетное поле, функция<br>`load_order_data_hist()`           | dwh_ods               | order_data_hist           | deleted_flg                | boolean        | Флаг удаленной в источнике записи            |                |
| 6     |                       |                          | Расчетное поле, функция<br>`load_order_data_hist()`                             | dwh_ods               | order_data_hist           | deleted_dttm               | timestamptz(0) | Дата/время удаления записи                   |                |
| 7     | dwh_stage             | order_data_cdc           | src_name                                                                        | dwh_ods               | order_data_hist           | src_name                   | varchar(255)   | Имя системы источника                        |                |
| 8     | dwh_stage             | order_data_cdc           | hash                                                                            | dwh_ods               | order_data_hist           | hash                       | text           | хэш строки источника                         |                |
| 9     | dwh_stage             | order_employers_data_cdc | order_id                                                                        | dwh_ods               | order_employers_data_hist | order_id                   | integer        | Идентификатор заказа                         |                |
| 10    | dwh_stage             | order_employers_data_cdc | employee_id                                                                     | dwh_ods               | order_employers_data_hist | employee_id                | integer        | Идентификатор сотрудника                     |                |
| 11    | dwh_stage             | order_employers_data_cdc | update_dttm<br>Расчетное поле, функция<br>`load_order_employers_data_hist()`    | dwh_ods               | order_employers_data_hist | valid_from_dttm            | timestamptz(0) | Дата/время начала действия версии            |                |
| 12    | dwh_stage             | order_employers_data_cdc | update_dttm<br>Расчетное поле, функция<br>`load_order_employers_data_hist()`    | dwh_ods               | order_employers_data_hist | valid_to_dttm              | timestamptz(0) | Дата/время конца действия версии             |                |
| 13    | dwh_stage             | order_employers_data_cdc | operation_type<br>Расчетное поле, функция<br>`load_order_employers_data_hist()` | dwh_ods               | order_employers_data_hist | deleted_flg                | boolean        | Флаг удаленной в источнике записи            |                |
| 14    |                       |                          | Расчетное поле, функция<br>`load_order_employers_data_hist()`                   | dwh_ods               | order_employers_data_hist | deleted_dttm               | timestamptz(0) | Дата/время удаления записи                   |                |
| 15    | dwh_stage             | order_employers_data_cdc | src_name                                                                        | dwh_ods               | order_employers_data_hist | src_name                   | varchar(255)   | Имя системы источника                        |                |
| 16    | dwh_stage             | order_employers_data_cdc | hash                                                                            | dwh_ods               | order_employers_data_hist | hash                       | text           | хэш строки источника                         |                |
| 17    | dwh_stage             | order_status_dict        | status_id                                                                       | dwh_ods               | order_status_dict_hist    | status_id                  | integer        | Идентификатор статуса                        |                |
| 18    | dwh_stage             | order_status_dict        | status_name                                                                     | dwh_ods               | order_status_dict_hist    | status_name                | text           | Название статуса                             |                |
| 19    | dwh_stage             | order_status_dict        | next_status_list                                                                | dwh_ods               | order_status_dict_hist    | next_status_list           | integer[]      | Список ИД возможных следующих статусов       |                |
| 20    | dwh_stage             | order_status_dict        | load_dttm<br>Расчетное поле, функция<br>`load_status_dict_hist()`               | dwh_ods               | order_status_dict_hist    | valid_from_dttm            | timestamptz(0) | Дата/время начала действия версии            |                |
| 21    | dwh_stage             | order_status_dict        | load_dttm<br>Расчетное поле, функция<br>`load_status_dict_hist()`               | dwh_ods               | order_status_dict_hist    | valid_to_dttm              | timestamptz(0) | Дата/время конца действия версии             |                |
| 22    |                       |                          | Расчетное поле, функция<br>`load_status_dict_hist()`                            | dwh_ods               | order_status_dict_hist    | deleted_flg                | boolean        | Флаг удаленной в источнике записи            |                |
| 23    |                       |                          | Расчетное поле, функция<br>`load_status_dict_hist()`                            | dwh_ods               | order_status_dict_hist    | deleted_dttm               | timestamptz(0) | Дата/время удаления записи                   |                |
| 24    | dwh_stage             | order_status_dict        | src_name                                                                        | dwh_ods               | order_status_dict_hist    | src_name                   | varchar(255)   | Имя системы источника                        |                |
| 25    | dwh_stage             | order_status_dict        | hash                                                                            | dwh_ods               | order_status_dict_hist    | hash                       | text           | хэш строки источника                         |                |
| 26    | dwh_stage             | employers_dict           | employee_id                                                                     | dwh_ods               | employers_dict_hist       | employee_id                | integer        | Идентификатор сотрудника                     |                |
| 27    | dwh_stage             | employers_dict           | employee_name                                                                   | dwh_ods               | employers_dict_hist       | employee_name              | text           | Имя сотрудника                               |                |
| 28    | dwh_stage             | employers_dict           | sex_flg                                                                         | dwh_ods               | employers_dict_hist       | sex_flg                    | boolean        | Пол сотрудника (False - female, True - male) |                |
| 29    | dwh_stage             | employers_dict           | age_num                                                                         | dwh_ods               | employers_dict_hist       | age_num                    | integer        | Возраст сотрудника (кол-во полных лет)       |                |
| 30    | dwh_stage             | employers_dict           | load_dttm<br>Расчетное поле, функция<br>`load_employers_dict_hist()`            | dwh_ods               | employers_dict_hist       | valid_from_dttm            | timestamptz(0) | Дата/время начала действия версии            |                |
| 31    | dwh_stage             | employers_dict           | load_dttm<br>Расчетное поле, функция<br>`load_employers_dict_hist()`            | dwh_ods               | employers_dict_hist       | valid_to_dttm              | timestamptz(0) | Дата/время конца действия версии             |                |
| 32    |                       |                          | Расчетное поле, функция<br>`load_employers_dict_hist()`                         | dwh_ods               | employers_dict_hist       | deleted_flg                | boolean        | Флаг удаленной в источнике записи            |                |
| 33    |                       |                          | Расчетное поле, функция<br>`load_employers_dict_hist()`                         | dwh_ods               | employers_dict_hist       | deleted_dttm               | timestamptz(0) | Дата/время удаления записи                   |                |
| 34    | dwh_stage             | employers_dict           | src_name                                                                        | dwh_ods               | employers_dict_hist       | src_name                   | varchar(255)   | Имя системы источника                        |                |
| 35    | dwh_stage             | employers_dict           | hash                                                                            | dwh_ods               | employers_dict_hist       | hash                       | text           | хэш строки источника                         |                |


## Система - приемник - слой  report

### Задание на построение таблиц в слое **report**
 
  1. Построить мат. представление, отражающее актуальное состояние заказов, их статусов и ответственных сотрудников
  2. построить мат. представление содержащее статистику по всем полученным заказам
     - дата/время старта и окончания выполнения заказа
     - время жизни заказа
     - первый и последний статус заказа
     - первый и последний сотрудник, ответственный за заказ
     - сотрудник, который был ответственным за заказ чаще всего (приоритезация по моменту первого взятия заказа)
     - общее количество сотрудников, взаимодействующих с заказом
     - демографическая информация по сотрудникам в разрезе по заказу (процент муж/жен.), средний возраст
  3. построить мат. представление содержащее статистику по всем сотрудникам
     - основная информация о сотруднике
     - общее количество взятых заказов
     - среднее время взаимодействия с заказом
     - количество взятых заказов по статусам
  4. построить мат. представление содержащее статистику по сотрудникам в разрезе по дням с использованием календаря
     - дата взятия первого заказа и последнего заказа в этот день
     - общее количество сотрудников, задействованных с заказами в этот день
     - количество уникальных сотрудников, задействованных с заказами в этот день
     - демографическая информация по задействованным сотрудникам: процент муж/жен, средний возраст, наиболее активная возрастная группа сотрудников
     - наиболее активный сотрудник в этот день (приоритезация по времени взятия заказа)
  5. построить мат. представление содержащее статистику по заказам в разрезе по дням с использованием календаря
     - общее количество задействованных заказов в этот день
     - общее количество уникальных задействованных заказов в этот день
     - общее количество уникальных задействованных статусов заказов в этот день
     - доля удаленных заказов в этот день
     - временной штамп взятия первого заказа
     - временной штамп взятия последнего заказа   
     - наиболее частый статус заказа в этот день   
           
### Модель данных и S2T для сущностей схемы `report` 

| **#** | **Область источника** | **Таблица-источник**      | **Поле таблицы-источника**                         | **Область приемника** | **Таблица-приемник**    | **Поле таблицы-приемника** | **Тип данных** | **Описание поля**                                                             | **Примечание** |
|-------|-----------------------|---------------------------|----------------------------------------------------|-----------------------|-------------------------|----------------------------|----------------|-------------------------------------------------------------------------------|----------------|
| 1     | dwh_ods               | order_data_hist           | order_id                                           | report                | _dm_order_state_tech    | order_id                   | integer        | Идентификатор заказа                                                          |                |
| 2     | dwh_ods               | order_data_hist           | status_id                                          | report                | _dm_order_state_tech    | status_id                  | integer        | Идентификатор статуса                                                         |                |
| 3     | dwh_ods               | order_status_dict_hist    | status_name                                        | report                | _dm_order_state_tech    | status_name                | text           | Название статуса                                                              |                |
| 4     | dwh_ods               | order_employers_data_hist | employee_id                                        | report                | _dm_order_state_tech    | employee_id                | integer        | Идентификатор сотрудника                                                      |                |
| 5     | dwh_ods               | employers_dict_hist       | employee_name                                      | report                | _dm_order_state_tech    | employee_name              | text           | Имя сотрудника                                                                |                |
| 6     | dwh_ods               | employers_dict_hist       | sex_flg                                            | report                | _dm_order_state_tech    | sex_flg                    | boolean        | Пол сотрудника (False - female, True - male)                                  |                |
| 7     | dwh_ods               | employers_dict_hist       | age_num                                            | report                | _dm_order_state_tech    | age_num                    | integer        | Возраст сотрудника (кол-во полных лет)                                        |                |
| 8     |                       |                           | valid_from_dttm<br>Расчетное поле                  | report                | _dm_order_state_tech    | valid_from_dttm            | timestamptz(0) | Дата/время начала действия версии                                             |                |
| 9     |                       |                           | valid_to_dttm<br>Расчетное поле                    | report                | _dm_order_state_tech    | valid_to_dttm              | timestamptz(0) | Дата/время конца действия версии                                              |                |
| 10    | dwh_ods               | order_data_hist           | deleted_flg                                        | report                | _dm_order_state_tech    | deleted_flg                | boolean        | Флаг удаленной в источнике записи                                             |                |
| 11    | dwh_ods               | order_data_hist           | deleted_dttm                                       | report                | _dm_order_state_tech    | deleted_dttm               | timestamptz(0) | Дата/время удаления записи                                                    |                |
| 12    | report                | _dm_order_state_tech      | order_id                                           | report                | dm_actual_order_state   | order_id                   | integer        | Идентификатор заказа                                                          |                |
| 13    | report                | _dm_order_state_tech      | status_name                                        | report                | dm_actual_order_state   | status_name                | text           | Название статуса                                                              |                |
| 14    | report                | _dm_order_state_tech      | employee_name                                      | report                | dm_actual_order_state   | employee_name              | text           | Имя сотрудника                                                                |                |
| 15    | report                | _dm_order_state_tech      | sex_flg                                            | report                | dm_actual_order_state   | sex_flg                    | boolean        | Пол сотрудника (False - female, True - male)                                  |                |
| 16    | report                | _dm_order_state_tech      | age_num                                            | report                | dm_actual_order_state   | age_num                    | integer        | Возраст сотрудника (кол-во полных лет)                                        |                |
| 17    | report                | _dm_order_state_tech      | valid_from_dttm                                    | report                | dm_actual_order_state   | valid_from_dttm            | timestamptz(0) | Дата/время начала действия версии                                             |                |
| 18    | report                | _dm_order_state_tech      | valid_to_dttm                                      | report                | dm_actual_order_state   | valid_to_dttm              | timestamptz(0) | Дата/время конца действия версии                                              |                |
| 19    | report                | _dm_order_state_tech      | deleted_flg                                        | report                | dm_actual_order_state   | deleted_flg                | boolean        | Флаг удаленной в источнике записи                                             |                |
| 20    | report                | _dm_order_state_tech      | deleted_dttm                                       | report                | dm_actual_order_state   | deleted_dttm               | timestamptz(0) | Дата/время удаления записи                                                    |                |
| 21    | dwh_ods               | order_data_hist           | order_id                                           | report                | dm_actual_order_state_2 | order_id                   | integer        | Идентификатор заказа                                                          |                |
| 22    | dwh_ods               | order_status_dict_hist    | status_name                                        | report                | dm_actual_order_state_2 | status_name                | text           | Название статуса                                                              |                |
| 23    | dwh_ods               | employers_dict_hist       | employee_name                                      | report                | dm_actual_order_state_2 | employee_name              | text           | Имя сотрудника                                                                |                |
| 24    | dwh_ods               | employers_dict_hist       | sex_flg                                            | report                | dm_actual_order_state_2 | sex_flg                    | boolean        | Пол сотрудника (False - female, True - male)                                  |                |
| 25    | dwh_ods               | employers_dict_hist       | age_num                                            | report                | dm_actual_order_state_2 | age_num                    | integer        | Возраст сотрудника (кол-во полных лет)                                        |                |
| 26    |                       |                           | valid_from_dttm<br>Расчетное поле                  | report                | dm_actual_order_state_2 | valid_from_dttm            | timestamptz(0) | Дата/время начала действия версии                                             |                |
| 27    |                       |                           | valid_to_dttm<br>Расчетное поле                    | report                | dm_actual_order_state_2 | valid_to_dttm              | timestamptz(0) | Дата/время конца действия версии                                              |                |
| 28    | dwh_ods               | order_data_hist           | deleted_flg                                        | report                | dm_actual_order_state_2 | deleted_flg                | boolean        | Флаг удаленной в источнике записи                                             |                |
| 29    | dwh_ods               | order_data_hist           | deleted_dttm                                       | report                | dm_actual_order_state_2 | deleted_dttm               | timestamptz(0) | Дата/время удаления записи                                                    |                |
| 30    | dwh_ods               | order_employers_data_hist | employee_id                                        | report                | dm_emloyers_stat        | employee_id                | integer        | Идентификатор сотрудника                                                      |                |
| 31    | dwh_ods               | employers_dict_hist       | employee_name                                      | report                | dm_emloyers_stat        | employee_name              | text           | Имя сотрудника                                                                |                |
| 32    | dwh_ods               | employers_dict_hist       | sex_flg                                            | report                | dm_emloyers_stat        | sex_flg                    | boolean        | Пол сотрудника (False - female, True - male)                                  |                |
| 33    | dwh_ods               | employers_dict_hist       | age_num                                            | report                | dm_emloyers_stat        | age_num                    | integer        | Возраст сотрудника (кол-во полных лет)                                        |                |
| 34    | dwh_ods               | order_data_hist           | order_id<br>Расчетное поле                         | report                | dm_emloyers_stat        | orders_num                 | integer        | Количество заказов, взятых сотрудником                                        |                |
| 35    |                       |                           | valid_from_dttm<br>valid_to_dttm<br>Расчетное поле | report                | dm_emloyers_stat        | duration_avg               | numeric(14,2)  | Среднее время выполнения заказа сотрудником в секундах                        |                |
| 36    | dwh_ods               | order_employers_data_hist | valid_from_dttm                                    | report                | dm_emloyers_stat        | start_dttm                 | timestamptz(0) | Дата/время начала работы сотрудника                                           |                |
| 37    |                       |                           | valid_to_dttm<br>Расчетное поле                    | report                | dm_emloyers_stat        | end_dttm                   | timestamptz(0) | Дата/время окончания работы сотрудника                                        |                |
| 38    |                       |                           | status_id<br>Расчетное поле                        | report                | dm_emloyers_stat        | unfulfilled_num            | integer        | Кол-во заказов со статусом unfulfilled взятых сотрудником                     |                |
| 39    |                       |                           | status_id<br>Расчетное поле                        | report                | dm_emloyers_stat        | collected_num              | integer        | Кол-во заказов со статусом collected взятых сотрудником                       |                |
| 40    |                       |                           | status_id<br>Расчетное поле                        | report                | dm_emloyers_stat        | shipped_num                | integer        | Кол-во заказов со статусом shipped, взятых сотрудником                        |                |
| 41    |                       |                           | status_id<br>Расчетное поле                        | report                | dm_emloyers_stat        | arrived_num                | integer        | кол-во заказов со статусом arrived, взятых сотрудником                        |                |
| 42    |                       |                           | status_id<br>Расчетное поле                        | report                | dm_emloyers_stat        | received_num               | integer        | Кол-во заказов со статусом received, взятых сотрудником                       |                |
| 43    |                       |                           | status_id<br>Расчетное поле                        | report                | dm_emloyers_stat        | returned_num               | integer        | Кол-во заказов со статусом returned, взятых сотрудником                       |                |
| 44    |                       |                           | status_id<br>Расчетное поле                        | report                | dm_emloyers_stat        | closed_num                 | integer        | Кол-во заказв со статусом closed, взятых сотрудником                          |                |
| 45    |                       |                           | status_id<br>Расчетное поле                        | report                | dm_emloyers_stat        | deleted_num                | integer        | Кол-во удаленных из системы заказов, взятых сотрудником                       |                |
| 46    | dwh_ods               | order_data_hist           | order_id                                           | report                | dm_orders_stat          | order_id                   | integer        | Идентификатор заказа                                                          |                |
| 47    |                       |                           | status_name<br>Расчетное поле                      | report                | dm_orders_stat          | first_status               | text           | Первый статус заказа                                                          |                |
| 48    |                       |                           | status_name<br>Расчетное поле                      | report                | dm_orders_stat          | last_status                | text           | Последний статус заказа                                                       |                |
| 49    | dwh_ods               | order_data_hist           | deleted_flg                                        | report                | dm_orders_stat          | deleted_flg                | boolean        | Флаг заказа, удаленного из источника                                          |                |
| 50    |                       |                           | valid_from_dttm<br>Расчетное поле                  | report                | dm_orders_stat          | start_dttm                 | timestamptz(0) | Дата/время начала выполнения заказа                                           |                |
| 51    |                       |                           | valid_to_dttm<br>Расчетное поле                    | report                | dm_orders_stat          | end_dttm                   | timestamptz(0) | Дата/время завершения выполнения заказа                                       |                |
| 52    | dwh_ods               | order_data_hist           | deleted_dttm                                       | report                | dm_orders_stat          | deleted_dttm               | timestamptz(0) | Дата/время удаления заказа                                                    |                |
| 53    |                       |                           | valid_from_dttm<br>valid_to_dttm<br>Расчетное поле | report                | dm_orders_stat          | duration                   | numeric(14,2)  | Длительность выполнения заказа в секундах                                     |                |
| 54    |                       |                           | employee_name<br>Расчетное поле                    | report                | dm_orders_stat          | first_emp                  | text           | Первый сотрудник заказа                                                       |                |
| 55    |                       |                           | employee_name<br>Расчетное поле                    | report                | dm_orders_stat          | last_emp                   | text           | Последний сотрудник заказа                                                    |                |
| 56    |                       |                           | employee_name<br>Расчетное поле                    | report                | dm_orders_stat          | most_active_emp            | text           | Наиболее активный сотрудник заказа                                            |                |
| 57    |                       |                           | employee_id<br>Расчетное поле                      | report                | dm_orders_stat          | employee_num               | integer        | Количество уникальных сотрудников, обслуживающих заказ                        |                |
| 58    |                       |                           | sex_flg<br>Расчетное поле                          | report                | dm_orders_stat          | male_prp_num               | numeric(14,2)  | Доля мужчин среди сотрудников обслуживающих заказ                             |                |
| 59    |                       |                           | sex_flg<br>Расчетное поле                          | report                | dm_orders_stat          | female_prp_num             | numeric(14,2)  | Доля женщин среди сотрудников обслуживающих заказ                             |                |
| 60    |                       |                           | age_num<br>Расчетное поле                          | report                | dm_orders_stat          | min_age_num                | integer        | Минимальный возраст обслуживающих заказ сотрудников                           |                |
| 61    |                       |                           | age_num<br>Расчетное поле                          | report                | dm_orders_stat          | max_age_num                | integer        | Максимальный возраст обслуживающих заказ сотрудников                          |                |
| 62    |                       |                           | age_num<br>Расчетное поле                          | report                | dm_orders_stat          | avg_age_num                | numeric(14,2)  | Средний возраст обслуживающих заказ сотрудников                               |                |
| 63    | dwh_ods               | date_calendar             | date_id                                            | report                | _dm_date_stat_tech      | date_id                    | integer        | Идентификатор даты из календаря                                               |                |
| 64    | dwh_ods               | order_data_hist           | order_id                                           | report                | _dm_date_stat_tech      | order_id                   | integer        | Идентификатор заказа                                                          |                |
| 65    | dwh_ods               | order_data_hist           | status_id                                          | report                | _dm_date_stat_tech      | status_id                  | integer        | Идентификатор статуса                                                         |                |
| 66    | dwh_ods               | order_data_hist           | deleted_flg                                        | report                | _dm_date_stat_tech      | deleted_flg                | boolean        | Флаг удаленной в источнике записи                                             |                |
| 67    |                       |                           | valid_from_dttm<br>Расчетное поле                  | report                | _dm_date_stat_tech      | valid_from_dttm            | timestamptz(0) | Дата/время первого изменения статуса заказа начатого в этот день              |                |
| 68    |                       |                           | valid_to_dttm<br>Расчетное поле                    | report                | _dm_date_stat_tech      | valid_to_dttm              | timestamptz(0) | Дата/время последнего изменения статуса завершенного в этот день              |                |
| 69    | dwh_ods               | order_status_dict_hist    | status_name                                        | report                | _dm_date_stat_tech      | status_name                | text           | Имя статуса заказа                                                            |                |
| 70    | dwh_ods               | order_employers_data_hist | employee_id                                        | report                | _dm_date_stat_tech      | employee_id                | integer        | Идентификатор сотрудника                                                      |                |
| 71    | dwh_ods               | employers_dict_hist       | employee_name                                      | report                | _dm_date_stat_tech      | employee_name              | text           | Имя сотрудника                                                                |                |
| 72    | dwh_ods               | employers_dict_hist       | sex_flg                                            | report                | _dm_date_stat_tech      | sex_flg                    | boolean        | Пол сотрудника (False - female, True - male)                                  |                |
| 73    | dwh_ods               | employers_dict_hist       | age_num                                            | report                | _dm_date_stat_tech      | age_num                    | integer        | Возраст сотрудника (кол-во полных лет)                                        |                |
| 74    |                       |                           | valid_from_dttm<br>Расчетное поле                  | report                | _dm_date_stat_tech      | is_ord_from_past           | boolean        | Флаг заказа перешедшего в этот день из прошлого                               |                |
| 75    |                       |                           | valid_to_dttm<br>Расчетное поле                    | report                | _dm_date_stat_tech      | is_ord_from_feat           | boolean        | Флаг заказа переходящего в будущее                                            |                |
| 76    |                       |                           | employee_name<br>Расчетное поле                    | report                | _dm_date_stat_tech      | most_active_emp            | text           | Имя наиболее активного пользователя в этот день                               |                |
| 77    |                       |                           | status_id<br>Расчетное поле                        | report                | _dm_date_stat_tech      | most_active_sts            | integer        | ИД наиболее активного статуса в этот день                                     |                |
| 78    |                       |                           | status_name<br>Расчетное поле                      | report                | _dm_date_stat_tech      | most_freq_sts_nm           | text           | Название наиболее активного статуса в этот день                               |                |
| 79    |                       |                           | age_num<br>Расчетное поле                          | report                | _dm_date_stat_tech      | most_active_age_group      | text           | Наиболее активная возрастная группа сотрудников в этот день                   |                |
| 80    |                       |                           | valid_from_dttm<br>Расчетное поле                  | report                | _dm_date_stat_tech      | most_freq_start_int        | text           | Время дня, в котором чаще всего стартовали заказы, начатые в этот день        |                |
| 81    |                       |                           | valid_to_dttm<br>Расчетное поле                    | report                | _dm_date_stat_tech      | most_freq_end_int          | text           | Время дня, в котором чаще всего завершались заказы, завершающиеся в этот день |                |
| 82    | report                | _dm_date_stat_tech        | date_id                                            | report                | dm_date_dem_stat        | date_id                    | integer        | Идентификатор даты из календаря                                               |                |
| 83    |                       |                           | valid_from_dttm<br>Расчетное поле                  | report                | dm_date_dem_stat        | first_order_start_dttm     | timestamptz(0) | Дата/время первого изменения статуса заказа начатого в этот день              |                |
| 84    |                       |                           | valid_to_dttm<br>Расчетное поле                    | report                | dm_date_dem_stat        | last_order_end_dttm        | timestamptz(0) | Дата/время последнего изменения статуса завершенного в этот день              |                |
| 85    |                       |                           | employee_id<br>Расчетное поле                      | report                | dm_date_dem_stat        | employee_num               | integer        | Количество сотрудников, обслуживающих заказы в этот день                      |                |
| 86    |                       |                           | employee_id<br>Расчетное поле                      | report                | dm_date_dem_stat        | uniq_employee_num          | integer        | Количество уникальных сотрудников, обслуживающих заказы в этот день           |                |
| 87    |                       |                           | sex_flg<br>Расчетное поле                          | report                | dm_date_dem_stat        | male_prp_num               | numeric(14.2)  | Доля мужчин среди сотрудников, обслуживающих заказы в этот день               |                |
| 88    |                       |                           | sex_flg<br>Расчетное поле                          | report                | dm_date_dem_stat        | female_prp_num             | numeric(14.2)  | Доля женщин среди сотрудников, обслуживающих заказы в этот день               |                |
| 89    |                       |                           | age_num<br>Расчетное поле                          | report                | dm_date_dem_stat        | avg_age_num                | numeric(14.2)  | Средний возраст обслуживающих заказ сотрудников                               |                |
| 90    | report                | _dm_date_stat_tech        | most_active_age_group                              | report                | dm_date_dem_stat        | most_active_age_group      | text           | Наиболее активная возрастная группа сотрудников в этот день                   |                |
| 91    | report                | _dm_date_stat_tech        | most_active_emp                                    | report                | dm_date_dem_stat        | most_active_emp            | text           | Наиболее активный сотрудник в этот день                                       |                |
| 92    | report                | _dm_date_stat_tech        | most_freq_start_int                                | report                | dm_date_dem_stat        | most_freq_start_int        | text           | Время дня, в котором чаще всего стартовали заказы, начатые в этот день        |                |
| 93    | report                | _dm_date_stat_tech        | most_freq_end_int                                  | report                | dm_date_dem_stat        | most_freq_end_int          | text           | Время дня, в котором чаще всего завершались заказы, завершающиеся в этот день |                |
| 94    |                       |                           |                                                    |                       |                         |                            |                |                                                                               |                |
| 95    | report                | _dm_date_stat_tech        | date_id                                            | report                | dm_date_order_stat      | date_id                    | integer        | Идентификатор даты из календаря                                               |                |
| 96    |                       |                           | order_num<br>Расчетное поле                        | report                | dm_date_order_stat      | order_num                  | integer        | Количество заказов, взятых в этот день                                        |                |
| 97    |                       |                           | order_num<br>Расчетное поле                        | report                | dm_date_order_stat      | uniq_order_num             | integer        | Количество уникальных заказов, взятых в этот день                             |                |
| 98    | report                | _dm_date_stat_tech        | status_id                                          | report                | dm_date_order_stat      | uniq_status_num            | integer        | Количество уникальных статусов в этот день                                    |                |
| 99    |                       |                           | valid_from_dttm<br>Расчетное поле                  | report                | dm_date_order_stat      | first_order_start_dttm     | timestamptz(0) | Дата/время первого изменения статуса в этот день                              |                |
| 100   |                       |                           | valid_to_dttm<br>Расчетное поле                    | report                | dm_date_order_stat      | last_order_end_dttm        | timestamptz(0) | Дата/время последнего изменения статуса в этот день                           |                |
| 101   | report                | _dm_date_stat_tech        | most_active_sts                                    | report                | dm_date_order_stat      | most_active_sts            | integer        | Идентификатор наиболее частого статуса заказа в этот день                     |                |
| 102   | report                | _dm_date_stat_tech        | most_freq_sts_nm                                   | report                | dm_date_order_stat      | most_freq_sts_nm           | text           | Название наиболее частого статуса заказа в этот день                          |                |
| 103   | report                | _dm_date_stat_tech        | most_freq_start_int                                | report                | dm_date_order_stat      | most_freq_start_int        | text           | Время дня, в котором чаще всего стартовали заказы, начатые в этот день        |                |
| 104   | report                | _dm_date_stat_tech        | most_freq_end_int                                  | report                | dm_date_order_stat      | most_freq_end_int          | text           | Время дня, в котором чаще всего завершались заказы, завершающиеся в этот день |                |           

### Алгоримы построения представлений в слое **report**

Для представлений `_dm_order_state_tech`, `dm_actual_order_state`, `dm_actual_order_state_2`, `dm_orders_stat` и `dm_emloyers_stat` таблица `dwh_ods.order_data_hist` соединяется слева с `dwh_ods.order_employers_data_hist` и словарями по соответствующему ИД, и с условием пересечения версий левой и правой таблицы (`OVERLAPS`)

Для представлений `dm_actual_order_state`, `dm_actual_order_state_2` выводятся только записи, актуальные на текущий момент (проверка по valid_to_dttm >= now())
При этом представление `dm_actual_order_state` берет в качестве основы представление `_dm_order_state_tech`, содержащее полные неагреггированные данные, в качестве эксперимента.
Представления `dm_actual_order_state` и `dm_actual_order_state_2` выводят идентичные значения.

Для представления `dm_orders_stat` и `dm_emloyers_stat` высчитываются метрики при помощи аггрегирующих функций в несколько этапов используя CTE, для определения наиболее частых сотрудников и статусов на каждом этапе производится подсчет количества соответствующих пользователей и статусов и аггрегация max, min или avg на последнем этапе.

Представление `_dm_date_stat_tech` высчитывает неагреггированные данные в разрезе по дням для каждого заказа, действующего в этот день, используя несколько CTE, в которых последовательно высчитываются количества одинаковых статусов или сотрудников, свойств этих сотрудников оконными функциями, для использования в финальных представляениях `dm_date_order_stat` и `dm_date_dem_stat`

Представления `dm_date_order_stat` и `dm_date_dem_stat` выводят аггрегированные данные из  технического представления `_dm_date_stat_tech`, относящиеся к сотрудникам или заказам, а также заранее подготовленные данные в `_dm_date_stat_tech` и группируют указанные записи по датам календаря. 

## Система - приемник - слой  _test

Слой _test содержит служебные таблицы с логами работы Airflow и результатами проверок данных, запускаемых Airflow, а также служебные процедуры, позволяющие имитировать работу источника и приемника.

### Модель данных _test

| **#** | **Схема** | **Сущность**      | **Наименование поля** | **Описание поля**                                                        | **PK/FK** | **Тип данных** | **FK-сущность** | **FK-поле** |
|-------|-----------|-------------------|-----------------------|--------------------------------------------------------------------------|-----------|----------------|-----------------|-------------|
| 1     | _test     | airflow_check_log | log_dttm              | Дата и время выполнения проверки в даге                                  |           | timestamptz(0) |                 |             |
| 2     |           |                   | odh_pk_nulls_cnt      | Количество значений NULL в первичном ключе order_data_hist               |           | integer        |                 |             |
| 3     |           |                   | oedh_pk_nulls_cnt     | Количество значений NULL в первичном ключе order_employers_data_hist     |           | integer        |                 |             |
| 4     |           |                   | odh_pk_dups_cnt       | Количество дублей в первичном ключе order_data_hist                      |           | integer        |                 |             |
| 5     |           |                   | oedh_pk_dups_cnt      | Количество дублей в первичном ключе order_employers_data_hist            |           | integer        |                 |             |
| 6     |           |                   | odh_sdc_err_cnt       | Количество записей с нарушением версионности в order_data_hist           |           | integer        |                 |             |
| 7     |           |                   | oedh_sdc_err_cnt      | Количество записей с нарушением версионности в order_employers_data_hist |           | integer        |                 |             |
| 8     | _test     | airflow_task_log  | log_dttm              | Дата и время выполнения дага                                             |           | timestamptz(0) |                 |             |
| 9     |           |                   | task_name             | Название (идентификатор) задачи в даге                                   |           | varchar(255)   |                 |             |
| 10    |           |                   | rows_exp              | Ожидаемое количество строк для добавления/изменения/удаления             |           | integer        |                 |             |
| 11    |           |                   | rows_ord_upd          | Фактически измененное количество строк в order_data                      |           | integer        |                 |             |
| 12    |           |                   | rows_emp_upd          | Фактически измененное количество строк в order_employers_data            |           | integer        |                 |             |
| 13    |           |                   | rows_ord_imp          | Фактически загруженное количество строк order_data в приемник            |           | integer        |                 |             |
| 14    |           |                   | rows_emp_imp          | Фактически загруженное количество строк order_employers_data в приемник  |           | integer        |                 |             |
| 15    |           |                   | rows_status_dict_imp  | Фактически загруженное количество строк status_dict в приемник           |           | integer        |                 |             |
| 16    |           |                   | rows_emp_dict_imp     | Фактически загруженное количество строк employers_dict в приемник        |           | integer        |                 |             |
| 17    |           |                   | rows_inc_exp          | Рассчитанное количество строк в инкременте данных                        |           | integer        |                 |             |
| 18    |           |                   | rows_change_add       | Количество заменяемых строк (помеченных на удаление) удаленных из ODS    |           | integer        |                 |             |
| 19    |           |                   | rows_change_del       | Количество заменяемых строк (помеченных на удаление) вставленных из ODS  |           | integer        |                 |             |
| 20    |           |                   | rows_inc_add          | Количество фактически загруженных строк из инкремента                    |           | integer        |                 |             |
| 21    |           |                   | rows_calendar_add     | Количество добавленных строк в календарь date_calendar                   |           | integer        |                 |             |

### Процедуры, слой **_test**

> - `export_import_csv` -  служебная процедура запускающая обмен данными между источником и приемником через файловую систему
> - `export_import_db` - служебная процедура запускающая обмен данными между источником и приемником непосредственно через БД
> - `testing_procedure` - процедура запускающая генератор источника, обмен данными между источником и приемником и работу прототипа хранилища

### Тест-кейс прототипа, скрипт имитации работы источника и приемника, слой **_test**

Для имитации работы источника и приемника предлагается запускать следующий скрипт, имитирующий последовательное заполнение, изменения и удаление данных в приемнике, загрузку и преобразование данных источником, обновление мат. представлений.

```SQL
-- (0) очищаем таблицы с данными источника и приемника

TRUNCATE TABLE
               -- источник
               oltp_src_system.order_data,
               oltp_src_system.order_employers_data,
               oltp_cdc_src_system.order_data_cdc,
               oltp_cdc_src_system.order_employers_data_cdc,
               -- приемник
               dwh_ods.order_data_hist,
               dwh_ods.order_employers_data_hist,
               dwh_ods.order_status_dict_hist, 
               dwh_ods.employers_dict_hist,
               dwh_ods.date_calendar
    CASCADE;
-- (1) Первая итерация   
SELECT * FROM _test.testing_procedure(False);
-- (2) Вторая итерация   
SELECT * FROM _test.testing_procedure(False);
-- (3) Третья итерация   
SELECT * FROM _test.testing_procedure(False);
-- (4) Четвертая итерация   
SELECT * FROM _test.testing_procedure(False);
-- (5) Пятая итерация   
SELECT * FROM _test.testing_procedure(False);
-- (6) Шестая итерация   
SELECT * FROM _test.testing_procedure(False);
-- (7) Обновление материализованных представлений
REFRESH MATERIALIZED VIEW report._dm_date_stat_tech;
REFRESH MATERIALIZED VIEW report._dm_order_state_tech;
REFRESH MATERIALIZED VIEW report.dm_actual_order_state;
REFRESH MATERIALIZED VIEW report.dm_actual_order_state_2;
REFRESH MATERIALIZED VIEW report.dm_date_dem_stat;
REFRESH MATERIALIZED VIEW report.dm_date_order_stat;
REFRESH MATERIALIZED VIEW report.dm_emloyers_stat;
REFRESH MATERIALIZED VIEW report.dm_orders_stat;
```

### Скрипт проверок данных, используемых Airflow

```SQL
/* Проверка на NULL в PK order_data_hist*/
SELECT COUNT(1) 
FROM dwh_ods.order_data_hist 
WHERE order_id IS NULL;

/* Проверка на NULL в PK order_employers_data_hist*/
SELECT COUNT(1) 
FROM dwh_ods.order_employers_data_hist 
WHERE order_id IS NULL;

/* Проверка дублей в составном PK order_data_hist*/
SELECT sum(cnt::int) FROM (
    SELECT order_id, valid_from_dttm, count(*)>1 AS cnt
    FROM dwh_ods.order_data_hist 
    GROUP BY 1,2) _src;

/* Проверка дублей в составном PK order_employers_data_hist*/
SELECT sum(cnt::int) FROM (
    SELECT order_id, valid_from_dttm, count(*)>1 AS cnt
    FROM dwh_ods.order_employers_data_hist 
    GROUP BY 1,2) _src;
           
/* Проверка гладкости версионности order_data_hist*/           
SELECT sum(ERROR_CNT) AS ERROR_CNT 
FROM (SELECT CASE
	             WHEN max(valid_from_dttm) OVER (
	                 PARTITION BY order_id
                     ORDER BY valid_from_dttm
                     ROWS BETWEEN 1 FOLLOWING AND 1 FOLLOWING
                         ) NOT IN (valid_to_dttm + INTERVAL '1 second', 
                                   to_timestamp(32503633200)) THEN 1 
                 ELSE 0 
             END AS ERROR_CNT
      FROM dwh_ods.order_data_hist) AS src_;
/* Проверка гладкости версионности order_employers_data_hist*/           
SELECT sum(ERROR_CNT) AS ERROR_CNT 	
FROM (SELECT CASE
	             WHEN max(valid_from_dttm) OVER (
	                 PARTITION BY order_id
                     ORDER BY valid_from_dttm
                     ROWS BETWEEN 1 FOLLOWING AND 1 FOLLOWING
                         ) NOT IN (valid_to_dttm + INTERVAL '1 second', 
                                   to_timestamp(32503633200)) THEN 1 
                 ELSE 0 
             END AS ERROR_CNT
      FROM dwh_ods.order_employers_data_hist ) AS src_;    

```
# Этапы, выполняемые при проверке решения и добавлении новых данных

## Проверка решения

Для проверки решения требуется последовательно запустить следующие скрипты в БД PostgreSQL в указанном порядке для создания необходимых слоев, таблиц, правил и функций

1. `01_SRC_cdc_src__DDL_DML_student74_vasilyev_ab_19052023.sql`
2. `02_DWH_stage_ods_DDL_DML_student74_vasilyev_ab_19052023.sql`
3. `03_DWH_report_DDL_DQL_student74_vasilyev_ab_19052023.sql`
4. `04_DWH_test_check_DDL_DML_DQL_student74_vasilyev_ab_19052023.sql`

Пользователь БД PostgreSQL должен обладать правами на создание и заполнение таблиц в своей БД, создание триггеров, установки расширения `pgcrypto`

Для тестирования работы обмена данными между источником и приемником пользователь БД также должен иметь права на выполнение COPY и доступ к файловой системе.

В скрипте Airflow, прилагаемом к заданию, необходимо заменить значения полей словаря pg_connect на актуальные для БД PostgreSQL и его пользователю

и установить в окружение указанные в скрипте библиотеки Python

```python
pg_connect = {
    'dbname': 'student74_vasilyev_ab', # имя базы данных в PostgreSQL
    'host': 'localhost',               # адрес хоста с БД PostgreSQL
    'port': 5432,                      # порт на хосте с БД PostgreSQL
    'user': 'Student74',               # имя пользователя БД PostgreSQL
    'password': 'XXX'                  # пароль пользователя БД PostgreSQL
}
```

## Добавление новых данных в источник

При добавлении новых сущностей в источник требуется 

1. В слое **stage** приемника создать соответствующие таблицы с техническими полями:

| **#** | **Наименование поля** | **Описание поля**                | **Тип данных** |
|-------|-----------------------|----------------------------------|----------------|
| 1     | hash                  | хэш строки источника             | text           |
| 2     | src_name              | Имя системы источника            | varchar(255)   |
| 3     | load_dttm             | Дата и время загрузки в приемник | timestamptz(0) |

2. В слое **ODS** приемника создать соответствующие таблицы с техническими полями:

| **#** | **Наименование поля** | **Описание поля**                 | **Тип данных** |
|-------|-----------------------|-----------------------------------|----------------|
| 1     | valid_from_dttm       | Дата/время начала действия версии | timestamptz(0) |
| 2     | valid_to_dttm         | Дата/время конца действия версии  | timestamptz(0) |
| 3     | deleted_flg           | Флаг удаленной в источнике записи | boolean        |
| 4     | deleted_dttm          | Дата/время удаления записи        | timestamptz(0) |
| 5     | src_name              | Имя системы источника             | varchar(255)   |
| 6     | hash                  | хэш строки источника              | text           |


2. В слое **stage** приемника создать процедуры копирования добавленных в источник таблиц в созданные в шаге 1 таблицы приемника. В процедурах обеспечить расчет хэша поступающих строк, проставления информации о системе источнике и установку даты загрузки данных

3. В слое **ODS** приемника создать соответствующие процедуры для загрузки поступающих в слой stage новых таблиц
  - в качестве valid_from_dttm использовать update_dttm источника
  - valid_to_dttm определять как следующий по времени valid_from_dttm в разрезе по первичному ключу источника
  - deleted_flg определять из operation_type источника
  - deleted_dttm определять как now()

или воспользоваться шаблоном функци:
```SQL
CREATE OR REPLACE FUNCTION dwh_ods.load_order_data_hist()
    RETURNS integer[] 
    VOLATILE
    STRICT 
    LANGUAGE plpgsql
AS 
$$
/* Функция load_order_data_hist() для добавления данных в слой dwh_ods
 * Функция не принимает аргументов и работает только с таблицей 
 * dwh_stage.order_data_cdc и существующими данными в dwh_ods.order_data_hist
 * 1 часть - выделение инкремента от данных в stage по отношению к данным в dwh_ods
 * 2 и 3 часть - добавление и удаление (замена) записей, 
 * чья дата окончания версии должна быть изменена
 * 4 часть - добавление инкремента в ODS */
DECLARE
    ret_val integer[] := ARRAY[0, 0, 0, 0];
BEGIN
	-- 1
	/* Собираем временную таблицу с инкрементом */
	CREATE TEMP TABLE inc_temp_table ON COMMIT DROP AS
	    SELECT 
	        order_id, status_id, 
	        /* В качестве даты начала версии и окончания версии используются
	         * даты update_dttm и create_dttm из cdc таблиц, полученных из 
	         * источника.
	         * Дата загрузки в применик для расчета версионности в этом случае
	         * не используется load_dttm , так как конкретно этот прототип 
	         * приемника собирает информацию через определенные промежутки 
	         * времени, внутри которых источник мог несколько раз поменять 
	         * состояние своеих записей.
	         * Это решение именно для этого случая, в прочих прототипах может
	         * быть другая логика использования дат.
	         * Здесь мы используем update_dttm в качестве даты начала
	         * версии и последующий update_dttm - 1 сек в качестве даты 
	         * окончания, в разрезе каждого order_id.
             */
	        update_dttm AS valid_from_dttm,
	        lead(update_dttm - interval '1 second', 1, 
	             to_timestamp(32503633200)) OVER (
	                 PARTITION BY order_id
                     ORDER BY update_dttm
                     ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING
                         ) AS valid_to_dttm,
	        operation_type = 'D' AS deleted_flg,
	        CASE WHEN operation_type = 'D' 
	           THEN now() 
	           ELSE NULL 
	        END AS deleted_dttm,
	        src_name, hash
        FROM dwh_stage.order_data_cdc
	    /* Добавляем только новые строки, которых еще нет в ods слое
	     * проверяем по хэшу */
	    WHERE hash NOT IN (SELECT hash 
	                       FROM dwh_ods.order_data_hist);
	GET DIAGNOSTICS ret_val[1] = row_count; -- кол-во строк в инкременте
	-- 2                      
	/* Если в инкременте есть ИД который присутствует в существующей истории,
	 * то есть пришли новые данные по какому-то ИД, копируем последнюю версию
	 * этого ИД с новой датой конца версии = минимальной датой начала версии 
	 * в инкременте */
	INSERT INTO dwh_ods.order_data_hist (order_id, status_id,  
	                                     valid_from_dttm, valid_to_dttm,
	                                     deleted_flg, deleted_dttm,
	                                     src_name, hash)
	    SELECT dst.order_id, dst.status_id, 
	           dst.valid_from_dttm,
	           inc.next_valid_from_dttm - interval '1 second' AS valid_to_dttm,
	           dst.deleted_flg,
	           dst.deleted_dttm,
	           dst.src_name, dst.hash
	    FROM dwh_ods.order_data_hist dst
	    INNER JOIN (SELECT order_id, 
	                       min(valid_from_dttm) AS next_valid_from_dttm
	                FROM inc_temp_table
	                GROUP BY 1) inc
	    ON dst.order_id = inc.order_id AND
	       dst.valid_to_dttm = to_timestamp(32503633200);
	GET DIAGNOSTICS ret_val[2] = row_count; -- кол-во добавленных строк 
	                                        -- c новой датой окончания	      
	-- 3      
	/*.. и удаляем существующую последнюю версию c датой окончания версии
	 * = 2999-12-31 */     
	DELETE FROM dwh_ods.order_data_hist
	WHERE order_id IN (SELECT order_id FROM inc_temp_table) AND
	      valid_to_dttm = to_timestamp(32503633200);
	GET DIAGNOSTICS ret_val[3] = row_count; -- кол-во удаленных строк 
	-- 4     
	/* Добавляем инкремент в целевую таблицу */
	INSERT INTO dwh_ods.order_data_hist
	    SELECT * FROM inc_temp_table;
	GET DIAGNOSTICS ret_val[4] = row_count; -- к-во добавл. строк из инкремента
    RAISE NOTICE 'order_data_hist:';
    RAISE NOTICE ' - Found new records for increment: %.', ret_val[1];
    RAISE NOTICE ' - Added new records (for replacement existing): %.', ret_val[2];     
    RAISE NOTICE ' - Deleted existing records: %. Check: %',  
        ret_val[3], ret_val[2]=ret_val[3];      
    RAISE NOTICE ' - Added new records (from increments): %. Check: %',
        ret_val[4], ret_val[1]=ret_val[4];         
    RETURN ret_val;	   
END;
$$;
```

4. В слое **report** cоздать представления для новых данных

5. Скрипт с dag для Airflow дополнить задачами для запуска новых функций
  - таски с загрузкой данных из источника разместить в группе `t_dwh_stage_import_group`
  - таски с загрузкой данных из stage приемника разместить в группе `t_dwh_ods_load_group`
  - заполнение результатов проверок и лога выполнения тасков разместить в конце дага

### Схема DAG Airflow

<image src="./05_dag_graph.png" width="1280" alt="Схема DAG Airflow">